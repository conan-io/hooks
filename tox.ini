[tox]
skipsdist=True
envlist =
    py{36,37,38,310}-conan{v1,v2}{dev,current,prev}

[testenv]
deps =
    conanv1dev: https://github.com/conan-io/conan/archive/develop.tar.gz
    conanv1current: https://github.com/conan-io/conan/archive/refs/tags/1.62.0.tar.gz
    conanv1prev: https://github.com/conan-io/conan/archive/refs/tags/1.61.0.tar.gz
    conanv2dev: https://github.com/conan-io/conan/archive/develop2.tar.gz
    conanv2prev: https://github.com/conan-io/conan/archive/refs/tags/2.0.16.tar.gz
    conanv2current: https://github.com/conan-io/conan/archive/refs/tags/2.0.17.tar.gz
    coverage: coverage-enable-subprocess
    -r {toxinidir}/tests/requirements_test.txt

install_command=python -m pip install --timeout 100 --retries 10 {opts} {packages}

setenv =
    PYTHONDONTWRITEBYTECODE=1
    PYTHONPATH = {toxinidir}{:}{env:PYTHONPATH:}
    USE_UNSUPPORTED_CONAN_WITH_PYTHON_2=1

    coverage: PYTEST_TEST_RUNNER=coverage run -m pytest
    coverage: COVERAGE_PROCESS_START={toxinidir}/.coveragerc
    coverage: COVERAGE_FILE={toxinidir}/.coverage
    coverage: PYTESTDJANGO_COVERAGE_SRC={toxinidir}/

passenv = PYTEST_ADDOPTS USE_UNSUPPORTED_CONAN_WITH_PYTHON_2 USERNAME ProgramFiles(x86) ProgramFiles

commands =
    python --version
    conan --version
    coverage: coverage erase
    conanv2dev: {env:PYTEST_TEST_RUNNER:pytest} {posargs:tests/test_hooks/conan-center-v2}
    conanv2current: {env:PYTEST_TEST_RUNNER:pytest} {posargs:tests/test_hooks/conan-center-v2}
    conanv2prev: {env:PYTEST_TEST_RUNNER:pytest} {posargs:tests/test_hooks/conan-center-v2}
    conanv1dev: {env:PYTEST_TEST_RUNNER:pytest} --ignore=tests/test_hooks/conan-center-v2 {posargs:tests}
    conanv1current: {env:PYTEST_TEST_RUNNER:pytest} --ignore=tests/test_hooks/conan-center-v2 {posargs:tests}
    conanv1prev: {env:PYTEST_TEST_RUNNER:pytest} --ignore=tests/test_hooks/conan-center-v2 {posargs:tests}
    coverage: coverage combine
    coverage: coverage report
    coverage: coverage xml
