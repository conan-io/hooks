pipeline {
    agent none
    stages {
        stage("Macos") {
            failFast true
            parallel {
                stage('Macos - py36') {
                    agent {
                        label 'M1Macos'
                    }
                    stages {
                        stage('Macos - py36 - Generate environment') {
                            environment {
                                PYVER = 'py36'
                            }
                            steps {
                                sh '.ci/generate_env_macos.sh'
                            }
                        }
                        stage('Macos - py36 - conandev') {
                            environment {
                                PYVER = 'py36'
                                TOXENV = 'py36-conandev'
                            }
                            steps {
                                sh '.ci/run_tox.sh'
                            }
                        }
                        stage('Macos - py36 - conanv1') {
                            environment {
                                PYVER = 'py36'
                                TOXENV = 'py36-conanv1'
                            }
                            steps {
                                sh '.ci/run_tox.sh'
                            }
                        }
                        stage('Macos - py36 - conanrel2') {
                            environment {
                                PYVER = 'py36'
                                TOXENV = 'py36-conanrel2'
                            }
                            steps {
                                sh '.ci/run_tox.sh'
                            }
                        }
                        stage('Macos - py36 - conanv2') {
                            environment {
                                PYVER = 'py36'
                                TOXENV = 'py36-conanv2'
                            }
                            steps {
                                sh '.ci/run_tox.sh'
                            }
                        }
                    }
                }
                stage('Macos - py38') {
                    agent {
                        label 'M1Macos'
                    }
                    stages {
                        stage('Macos - py38 - Generate environment') {
                            environment {
                                PYVER = 'py38'
                            }
                            steps {
                                sh '.ci/generate_env_macos.sh'
                            }
                        }
                        stage('Macos - py38 - conandev') {
                            environment {
                                PYVER = 'py38'
                                TOXENV = 'py38-conandev'
                            }
                            steps {
                                sh '.ci/run_tox.sh'
                            }
                        }
                        stage('Macos - py38 - conanv1') {
                            environment {
                                PYVER = 'py38'
                                TOXENV = 'py38-conanv1'
                            }
                            steps {
                                sh '.ci/run_tox.sh'
                            }
                        }
                        stage('Macos - py38 - conanrel2') {
                            environment {
                                PYVER = 'py38'
                                TOXENV = 'py38-conanrel2'
                            }
                            steps {
                                sh '.ci/run_tox.sh'
                            }
                        }
                        stage('Macos - py38 - conanv2') {
                            environment {
                                PYVER = 'py38'
                                TOXENV = 'py38-conanv2'
                            }
                            steps {
                                sh '.ci/run_tox.sh'
                            }
                        }
                    }
                }
            }
        }
        stage("Windows") {
            failFast true
            parallel {
                stage('Windows - py36') {
                    agent {
                        label 'Windows'
                    }
                    stages {
                        stage('Windows - py36 - Generate environment') {
                            environment {
                                PYVER = 'py36'
                            }
                            steps {
                                bat '.ci/generate_env_windows.bat'
                            }
                        }
                        stage('Windows - py36 - conanv1') {
                            environment {
                                TOXENV = 'py36-conanv1'
                            }
                            steps {
                                bat 'tox --recreate'
                            }
                        }
                        stage('Windows - py36 - conanrel2') {
                            environment {
                                TOXENV = 'py36-conanrel2'
                            }
                            steps {
                                bat 'tox --recreate'
                            }
                        }
                        stage('Windows - py36 - conanv2') {
                            environment {
                                TOXENV = 'py36-conanv2'
                            }
                            steps {
                                bat 'tox --recreate'
                            }
                        }
                    }
                }
                stage('Windows - py38') {
                    agent {
                        label 'Windows'
                    }
                    stages {
                        stage('Windows - py38 - Generate environment') {
                            environment {
                                PYVER = 'py38'
                            }
                            steps {
                                bat '.ci/generate_env_windows.bat'
                            }
                        }
                        stage('Windows - py38 - conanv1') {
                            environment {
                                TOXENV = 'py38-conanv1'
                            }
                            steps {
                                bat 'tox --recreate'
                            }
                        }
                        stage('Windows - py38 - conanv2') {
                            environment {
                                TOXENV = 'py38-conanv2'
                            }
                            steps {
                                bat 'tox --recreate'
                            }
                        }
                    }
                }
            }
        }
        stage("Linux") {
            failFast true
            parallel {
                stage('Linux - py36') {
                    agent {
                        label 'Linux'
                    }
                    stages {
                        stage('Linux - py36 - Generate environment') {
                            environment {
                                PYVER = 'py36'
                            }
                            steps {
                                sh '.ci/generate_env_linux.sh'
                            }
                        }
                        stage('Linux - py36 - conandev') {
                            environment {
                                TOXENV = 'py36-conandev'
                            }
                            steps {
                                sh '''
                                    eval "$(pyenv init -)"
                                    pyenv activate conan
                                    tox
                                '''
                            }
                        }
                        stage('Linux - py36 - conanv1') {
                            environment {
                                TOXENV = 'py36-conanv1'
                            }
                            steps {
                                sh '''
                                    eval "$(pyenv init -)"
                                    pyenv activate conan
                                    tox
                                '''
                            }
                        }
                        stage('Linux - py36 - conanrel2') {
                            environment {
                                TOXENV = 'py36-conanrel2'
                            }
                            steps {
                                sh '''
                                    eval "$(pyenv init -)"
                                    pyenv activate conan
                                    tox
                                '''
                            }
                        }
                        stage('Linux - py36 - conanv2') {
                            environment {
                                TOXENV = 'py36-conanv2'
                            }
                            steps {
                                sh '''
                                    eval "$(pyenv init -)"
                                    pyenv activate conan
                                    tox
                                '''
                            }
                        }
                    }
                }
                stage('Linux - py38') {
                    agent {
                        label 'Linux'
                    }
                    stages {
                        stage('Linux - py38 - Generate environment') {
                            environment {
                                PYVER = 'py38'
                            }
                            steps {
                                sh '.ci/generate_env_linux.sh'
                            }
                        }
                        stage('Linux - py38 - conandev') {
                            environment {
                                TOXENV = 'py38-conandev'
                            }
                            steps {
                                sh '''
                                    eval "$(pyenv init -)"
                                    pyenv activate conan
                                    tox
                                '''
                            }
                        }
                        stage('Linux - py38 - conanv1') {
                            environment {
                                TOXENV = 'py38-conanv1'
                            }
                            steps {
                                sh '''
                                    eval "$(pyenv init -)"
                                    pyenv activate conan
                                    tox
                                '''
                            }
                        }
                        stage('Linux - py38 - conanrel2') {
                            environment {
                                TOXENV = 'py38-conanrel2'
                            }
                            steps {
                                sh '''
                                    eval "$(pyenv init -)"
                                    pyenv activate conan
                                    tox
                                '''
                            }
                        }
                        stage('Linux - py38 - conanv2') {
                            environment {
                                TOXENV = 'py38-conanv2'
                            }
                            steps {
                                sh '''
                                    eval "$(pyenv init -)"
                                    pyenv activate conan
                                    tox
                                '''
                            }
                        }
                    }
                }
            }
        }
    }
}